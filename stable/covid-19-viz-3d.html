<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1.0,maximum-scale=1.0">
<meta name=description
	content="View the COVID-19 data from John Hopkins University GitHub repository in interactive 3D">
<meta name=keywords content="Three.js,WebGL,JavaScript,GitHub,FOSS,3D,STEM">
<meta name=version content="2020-03-19-15-01">


<title>COVID-19 Viz 3D</title>

<style>

/* Copyright 2020 Spider contributors. MIT License */

:root { font: 100% monospace; }

* { box-sizing: border-box; }

body { margin: 0; overflow: hidden; }

a { color: crimson; text-decoration: none; }
a:hover, a:focus, a:active { background-color: yellow; color: #aaa; text-decoration: underline; }

button { background-color: #ddd; border: none; border-radius: 2px; color: #322;cursor: pointer; padding: 3px 5px; }
button:hover { background: #ccc; color: #fff }

input[ type=range ] { -webkit-appearance: none; -moz-appearance: none; background-color: #ddd; border-radius: 2px; height: 1.7ch; width: 100%; }
input[ type=range ]::-moz-range-thumb { background-color: #888; border-radius: 2; width: 10px; }
input[ type=range ]::-webkit-slider-thumb { -webkit-appearance: none; background-color: #888; height: 18px; width: 10px; }

.help { float: right; }

.couponcode { float: right }

.couponcode:hover>.coupontooltip { display: block; }

.coupontooltip { border: 0.8ch double #888; background: white; display: none;
	font: 100% monospace; font-size: 1rem; font-weight: normal; /* unset summary settings */
	margin-left: -20ch; padding: 10px; position: absolute; z-index: 1000; }

#navMenu { margin: 0 20px; max-height: 100vh;  max-width: 15rem; overflow: auto; position: absolute; }

#divMessage { background-color:#eee; border-radius: 1rem; left: 5vw; padding: 1rem; position: absolute; top: 50vh;
	box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.9), 0 6px 20px 0 rgba(0, 0, 0, 0.6); }

</style>

</head>

<body>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r114/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r114/examples/js/controls/OrbitControls.js"></script>

<script src="threeGeoJSON.js"></script>

<nav id="navMenu">

	<header id="hdrTitle">

		<h2>
			<a id=aSource target=_top title="Readme & Source code on GitHub" >
				<img id=imgIcon height=18 style=opacity:0.5; >
			</a>

			<a href="" title="Click to reload this page" >
				<span id=sTitle ></span>
				<span id=sVersion ></span>
			</a>

			<span class="couponcode" >&#x24d8;<span id=divDescription class="coupontooltip" >
				View the COVID-19 data from the John Hopkins University
				<a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data" target="_blank">GitHub repository</a>
				in interactive 3D using JavaScript <a href="https://threeja.org" target="_blank">Three.js</a>
				WebGL tools.
			</span></span>

		</h2>

	</header>

	<p style=background-color:cyan;color:white;padding:1ch; >New cases</p>

	<p style=background-color:red;color:white;padding:1ch; >Confirmed cases</p>

	<p style=background-color:black;color:white;padding:1ch; title="Spread indicates high deaths to cases ratios" >Deaths</p>

	<p style=background-color:lightgreen;color:white;padding:1ch; >Recoveries</p>

	<div id=divStats style=background-color:white;padding:1ch; ></div>

	<div id=divSettings style=background-color:white;padding:1ch; ></div>


</nav>


<div id=divMessage >
	Touch the screen to stop rotation<br>
	Touch a country "stick" to pop-up the statistics<br>
	Two fingers or mousewheel to zoom
</div>

<script>

const pathAssets = "../assets/";
const path = "https://cdn.jsdelivr.net/gh/CSSEGISandData/COVID-19@master/csse_covid_19_data/csse_covid_19_daily_reports/"

aSource.href = "https://github.com/ladybug-tools/spider-covid-19-viz-3d/";
imgIcon.src = "https://pushme-pullyou.github.io/github-mark-32.png";

sTitle.innerHTML= document.title ? document.title : location.href.split( '/' ).pop().slice( 0, - 5 ).replace( /-/g, ' ' );
const version = document.head.querySelector( "[ name=version ]" );
sVersion.innerHTML = version ? version.content : "";
//divDescription.innerHTML = document.head.querySelector( "[ name=description ]" ).content;


let lines;
let json;
let yesterday;
let intersected;
let group = new THREE.Group();
let groupLines;
let mesh;
let renderer, camera, controls, scene;

init();
animate();



function init() {

	camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 1000 );
	camera.position.set( 100, 0, 100 );
	camera.up.set( 0, 0, 1 );

	scene = new THREE.Scene();
	scene.background = new THREE.Color( 0xcce0ff );
	scene.add( camera );

	renderer = new THREE.WebGLRenderer( { antialias: true } );
	renderer.setPixelRatio( window.devicePixelRatio );
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );
	renderer.outputEncoding = THREE.sRGBEncoding;

	controls = new THREE.OrbitControls( camera, renderer.domElement );
	controls.enablePan = false;
	controls.minDistance = 60;
	controls.maxDistance = 300;
	controls.autoRotate = true;

	window.addEventListener( 'resize', onWindowResize, false );
	window.addEventListener( 'orientationchange', onWindowResize, false );
	window.addEventListener( 'keyup', () => controls.autoRotate = false, false );

	renderer.domElement.addEventListener( 'wheel', () => controls.autoRotate = false, false );
	renderer.domElement.addEventListener( 'mousedown', () => controls.autoRotate = false, false );
	renderer.domElement.addEventListener( 'touchstart', () => controls.autoRotate = false, false );
	renderer.domElement.addEventListener( 'click', () => controls.autoRotate = false, false );

	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
	document.addEventListener( 'touchstart', onDocumentTouchStart, false );

	addLights();

	addGlobe();

	const url = "https://api.github.com/repos/CSSEGISandData/COVID-19/contents/csse_covid_19_data/csse_covid_19_daily_reports"

	requestFile( url, callbackDailyReport );


	const urlJsonStatesProvinces = pathAssets + "json/ne_50m_admin_1_states_provinces_lines.geojson";

	requestFile( urlJsonStatesProvinces, onLoadGeoJson );

	const urlJsonChina = pathAssets + "json/china.geojson";

	requestFile( urlJsonChina, onLoadGeoJson );

	const urlJson = pathAssets + "json/ne_110m_admin_0_countries_lakes.geojson";

	requestFile( urlJson, onLoadGeoJson );

	getSettings();

	addSkyBox()

}



function addSkyBox() {

	scene.background = new THREE.CubeTextureLoader()
	.setPath( pathAssets + "cube-textures/")
	.load( ['f1.jpg', 'f2.jpg', 'f3.jpg', 'f4.jpg', 'f5.jpg','f6.jpg'] );

}



function onLoadGeoJson( xhr ) {

	let response = xhr.target.response;

	json = JSON.parse( response )
	//console.log( '', response );

	drawThreeGeo( json, 50, 'sphere', { color: '#888' })

}



function addLights() {

	scene.add( new THREE.AmbientLight( 0xaaaaaa ) );

	const pointLight = new THREE.PointLight( 0xffffff, 1 );
	pointLight.position.copy( camera.position );
	camera.add( pointLight );

	const lightDirectional = new THREE.DirectionalLight( 0xfffffff, 1);
	lightDirectional.position.set( -50, -200, 100 );

}



function callbackDailyReport( xhr ) {

	const response = JSON.parse( xhr.target.response )

	const names = response.map( json => json.name )
	const today = names[ names.length - 2 ];
	//console.log( today );

	yesterday = names[ names.length - 3 ];

	//console.log( 'yesterday', yesterday );
	requestFile( path + today, onLoad );

}



function addGlobe( size = 50 ) {

	const geometry = new THREE.SphereGeometry( size, 50, 25 );
	geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( 0.5 * Math.PI ) );

	const url = pathAssets + "images/earth_atmos_4096.jpg";
	var texture = new THREE.TextureLoader().load( url );

	const material = new THREE.MeshBasicMaterial( { color: 0xcce0ff, map: texture } );
	mesh = new THREE.Mesh( geometry, material );
	scene.add( mesh );

}



function requestFile( url, callback ) {

	const xhr = new XMLHttpRequest();
	xhr.open( 'GET', url, true );
	xhr.onerror = ( xhr ) => console.log( 'error:', xhr  );
	//xhr.onprogress = ( xhr ) => console.log( 'bytes loaded:', xhr.loaded );
	xhr.onload = callback;
	xhr.send( null );

}



function onLoad( xhr ) {

	group = new THREE.Group();
	scene.add( group )

	let response = xhr.target.response;
	response = response.replace( /"Korea, South"/, "South Korea" )
	.replace( /"Gambia, The"/, "The Gambia")
	.replace( /"Bahamas, The"/, "The Bahamas");
	//.replace( /"Virgin Islands,/, "Virgin Islands");

	lines = response.split( "\n" ).map( line => line.split( "," ) ).slice( 1, -1 );
	//console.log( 'lines', lines );

	lines.push( [ "Test Case", "Null Island", "", "0", "", "0", "0", "0" ] );

	lines.forEach( ( line, index ) => addIndicator( line, index ) );

	requestFile( path + yesterday, onLoadYesterday );

}



function onLoadYesterday( xhr ) {

	let response = xhr.target.response;

	linesYesterday = response.split( "\n" ).map( line => line.split( "," ) ).slice( 1, -1 );
	//console.log( 'lines', lines );

	lines.forEach( ( line, index ) => addIndicatorNew( line, index ) );

	getStats();

}



function addIndicatorNew( line, index ) {

	const state = line[ 0 ];
	const country = line [ 1 ]

	const lineNew = linesYesterday.filter( line => line[ 0 ] === state && line[ 1 ] === country );
	//console.log( 'ln',line[ 3 ]);

	//if ( !lineNew.length ){ return; };

	str = lineNew.length ?lineNew[ 0 ][ 3 ] : ""

	num  = str ? Number( str ) : Number( line[ 3 ] );

	casesNew = Math.abs( Number( line[ 3 ] ) - num );

	lines[ index ].push( casesNew );
	//console.log( 'casesNew', casesNew, line );

	group.add( mesh );

	if ( casesNew < 1 ) {return; }

	const heightCases = 0.2 * Math.sqrt( Number( line[ 3 ] ) || 0 );
//	const heightNew = 0.2 * Math.sqrt( casesNew || 1 );

	const cases = Number( line[ 3 ] );
	const heightRatio = cases ? casesNew / cases : 0;
	//console.log( 'heightRatio', heightRatio );

	const height = heightCases * heightRatio;
	//console.log( 'height', height );

	p1 = latLonToXYZ( 50 + heightCases - 0.5 * height, Number( line[ 6 ] ), Number( line[ 7 ] ), index  );
	p2 = latLonToXYZ( 100, Number( line[ 6 ] ), Number( line[ 7 ] ), index );

	const geometry = new THREE.CylinderBufferGeometry( 0.45, 0.45 + heightRatio, height, 12, 1, true );
	geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( -0.5 * Math.PI ) );
	const material = new THREE.MeshPhongMaterial( { color: "cyan", opacity: 0.8, side: 2, transparent: true });
	mesh = new THREE.Mesh( geometry, material );
	mesh.position.copy( p1 );
	mesh.lookAt( p2 );
	mesh.userData = index;

	group.add( mesh );

}



function addIndicator( line, index ) {

	const height = 0.2 * Math.sqrt( Number( line[ 3 ] ) || 1 );
	const heightDeaths = 0.2 * Math.sqrt( Number( line[ 4 ] ) || 1 );
	const heightRecoveries = 0.2 * Math.sqrt( Number( line[ 5 ] ) || 1 );

	let p1 = latLonToXYZ( 50 + 0.5 * height, Number( line[ 6 ] ), Number( line[ 7 ] ), index  );
	let p2 = latLonToXYZ( 100, Number( line[ 6 ] ), Number( line[ 7 ] ), index );

	let geometry = new THREE.CylinderGeometry( 0.4, 0.4, height );
	geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( -0.5 * Math.PI ) );
	let material = new THREE.MeshPhongMaterial( { color: "red" });
	mesh = new THREE.Mesh( geometry, material );
	mesh.position.copy( p1 );
	mesh.lookAt( p2 );
	mesh.userData = index;

	group.add( mesh );


	p1 = latLonToXYZ( 50 + 0.5 * heightDeaths, Number( line[ 6 ] ), Number( line[ 7 ] ), index  );
	p2 = latLonToXYZ( 100, Number( line[ 6 ] ), Number( line[ 7 ] ), index );

	let dToC =  Number( line[ 3 ] ) > 0 ? 5 * Number( line[ 4 ] ) / Number( line[ 3 ] ) : 0;
	dToC = dToC < 1 ? dToC : 1;
	//console.log( 'dc', dToC );

	geometry = new THREE.CylinderBufferGeometry( 0.5, 0.5 + dToC, heightDeaths,12,1,true );
	geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( -0.5 * Math.PI ) );
	material = new THREE.MeshPhongMaterial( { color: "black", side: 2 });
	mesh = new THREE.Mesh( geometry, material );
	mesh.position.copy( p1 );
	mesh.lookAt( p2 );
	mesh.userData = index;


	group.add( mesh );

	p1 = latLonToXYZ( 50 + 0.5 * heightRecoveries, Number( line[ 6 ] ), Number( line[ 7 ] ), index  );
	p2 = latLonToXYZ( 100, Number( line[ 6 ] ), Number( line[ 7 ] ), index );

	geometry = new THREE.CylinderBufferGeometry( 0.45, 0.45, heightRecoveries, 12, 1, true );
	geometry.applyMatrix4( new THREE.Matrix4().makeRotationX( -0.5 * Math.PI ) );
	material = new THREE.MeshPhongMaterial( { color: "green" });
	mesh = new THREE.Mesh( geometry, material );
	mesh.position.copy( p1 );
	mesh.lookAt( p2 );
	mesh.userData = index;

	group.add( mesh );

}


function getStats() {

	const globalCases = lines.reduce( (sum, line ) => {
		let cases = Number( line[ 3 ] )
		cases = isNaN( cases ) ? 0 : cases;
		return sum + cases}
	, 0 );
	//console.log( '', globalCases);

	//caseNew = ;
	const globalCasesNew = lines.reduce( (sum, line ) => {
		let caseNew =  line[ 8 ];
		//console.log( 'caseNew', caseNew );
		return sum + caseNew;
	}, 0 );


	const globalDeaths = lines.reduce( (sum, line ) => sum + Number( line[ 4 ] ), 0 );
	const globalRecoveries = lines.reduce( (sum, line ) => sum + Number( line[ 5 ] ), 0 );
	const globalDeathsToCases = 100 * ( globalDeaths / globalCases );

	const chinaDeaths = lines.reduce( (sum, line ) => sum += line[ 1 ] === "China" ? Number( line[ 4 ] ) : 0, 0 );
	const chinaCasesNew = lines.reduce( (sum, line ) => sum += line[ 1 ] === "China" ? line[ 8 ] : 0, 0 );
	const chinaCases = lines.reduce( (sum, line ) => sum += line[ 1 ] === "China" ? Number( line[ 3 ] ) : 0, 0 );
	const chinaRecoveries = lines.reduce( (sum, line ) => sum += line[ 1 ] === "China" ? Number( line[ 5 ] ) : 0, 0 );
	const chinaDeathsToCases = 100 * chinaDeaths /chinaCases;

	const usaCases = lines.reduce( (sum, line ) => sum += line[ 1 ] === "US" ? Number( line[ 3 ] ) : 0, 0 );
	const usaCasesNew = lines.reduce( (sum, line ) => sum += line[ 1 ] === "US" ? line[ 8 ] : 0, 0 );
	const usaDeaths = lines.reduce( (sum, line ) => sum += line[ 1 ] === "US" ? Number( line[ 4 ] ) : 0, 0 );
	const usaRecoveries = lines.reduce( (sum, line ) => sum += line[ 1 ] === "US" ? Number( line[ 5 ] ) : 0, 0 );
	const usaDeathsToCases = 100 * ( usaDeaths / usaCases );

	divStats.innerHTML = `<details id=detStats>

	<summary><b>global statistics</b></summary>
	<p>
		<b>global</b><br>
		cases: ${ globalCases.toLocaleString() }<br>
		cases new: ${ globalCasesNew.toLocaleString() }<br>
		deaths: ${ globalDeaths.toLocaleString() }<br>
		recoveries: ${ globalRecoveries.toLocaleString() }<br>
		deaths/cases %: ${ globalDeathsToCases.toLocaleString() }<br>
	</p>

	<p>
		<b>China totals</b><br>
		cases: ${ chinaCases.toLocaleString() }<br>
		cases new: ${ chinaCasesNew.toLocaleString() }<br>
		deaths: ${ chinaDeaths.toLocaleString() }<br>
		recoveries: ${ chinaRecoveries.toLocaleString() }<br>
		deaths/cases %: ${ chinaDeathsToCases.toLocaleString() }<br>
	</p>

	<p>
		<b>USA totals</b><br>
		cases: ${ usaCases.toLocaleString() }<br>
		cases new: ${ usaCasesNew.toLocaleString() }<br>
		deaths: ${ usaDeaths.toLocaleString() }<br>
		recoveries: ${ usaRecoveries.toLocaleString() }<br>
		deaths/cases %: ${ usaDeathsToCases.toLocaleString() }<br>
	</p>

	<p>To be added: Canada, Australia, Europe & everyone</p>

	</details>`;

	detStats.open = window.innerWidth > 640;

}


function getSettings() {

	divSettings.innerHTML = `<details id=detSettings>

		<summary><b>notes & settings</b></summary>

		<p>Black bar spread indicates high deaths to cases ratio.</p>

		<p>Not all populations and GDPs are reported.
			<!--
			Some GDPs are in trillions and some are in billions.
			<a href="https://github.com/nvkelso/natural-earth-vector/tree/master/geojson" target="_blank">Go figure.</a></p>
			-->
			<p>
			<button onclick=controls.reset() >reset view</button>
			<button onclick="controls.autoRotate=!controls.autoRotate">rotation</button>
		</p>

	</details>`;

}



function latLonToXYZ( radius, lat, lon, index ) {

	const pi2 = Math.PI / 2;

	lat = Number( lat ) * Math.PI / 180;
	lon = Number( lon ) * Math.PI / 180;
	//console.log( "lat/lon", lat, lon, index);

	const x = radius * Math.sin( lat + pi2 ) * Math.cos( lon );
	const y = radius * Math.sin( lat + pi2 ) * Math.sin( lon );
	const z = radius * Math.cos( lat - pi2 );

	return new THREE.Vector3( x, y, z );

}



function onDocumentTouchStart( event ) {

	//event.preventDefault();

	event.clientX = event.touches[ 0 ].clientX;
	event.clientY = event.touches[ 0 ].clientY;

	onDocumentMouseMove( event );

};



function onDocumentMouseMove ( event ) {

	//event.preventDefault();

	const mouse = new THREE.Vector2();
	mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
	mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;

	const raycaster = new THREE.Raycaster();
	raycaster.setFromCamera( mouse, camera );

	const intersects = raycaster.intersectObjects( group.children );

	if ( intersects.length > 0 ) {

		if (  intersected !== intersects[ 0 ].object ) {

			intersected = intersects[ 0 ].object;

			const index = intersected.userData;

			const line = lines[ index ];

			country = line[ 1 ];

			arr = json.features.filter( feature => feature.properties.NAME === country );

			const feature = arr.length ? arr[ 0 ] : undefined;

			//console.log( 'feature', feature );

			let population, gdp;

			if ( feature ) {

				population = feature.properties.POP_EST;
				gdp = feature.properties.GDP_MD_EST;
				name = feature.properties.NAME;
			} else {

				population = 999999999;
				gdp = 999999999;
				name = "not found";

			}

			casesNew = line[ 8 ] ? line[ 8 ] :0;

			divMessage.hidden = false;
			divMessage.style.left = event.clientX  + "px";
			divMessage.style.top = event.clientY  + "px";
			divMessage.innerHTML = `
JHU place: ${ line[ 0 ] }<br>
country: ${ line[ 1 ] }<br>
update: ${ line[ 2 ] }<br>
cases: ${ Number( line[ 3 ] ).toLocaleString() }<br>
cases new: <mark>${ Number( casesNew ).toLocaleString() }</mark><br>
deaths: ${ Number( line[ 4 ] ).toLocaleString() }<br>
recovered: ${ Number( line[ 5 ] ).toLocaleString() }<br>
deaths/cases: ${ ( 100 * ( Number( line[ 4 ] ) / Number( line[ 3 ] ) ) ).toLocaleString() }%<br>
deaths/population: ${ ( 100 * ( Number( line[ 4 ] ) / population ) ).toLocaleString() }%<br>
deaths/gdp: ${ ( 100 * ( Number( line[ 4 ] ) / gdp ) ).toLocaleString() }%<br>
<hr>
geoJSON name: ${ name }<br>
population: ${ population.toLocaleString() }<br>
gdp: ${ gdp.toLocaleString() }<br>
`;

		}

	} else {

		intersected = null;
		divMessage.hidden = true;
		divMessage.innerHTML = "";

	}

};



function onWindowResize() {

	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();

	renderer.setSize( window.innerWidth, window.innerHeight );

	//console.log( 'onWindowResize  window.innerWidth', window.innerWidth );

}



function animate() {

	requestAnimationFrame( animate );
	renderer.render( scene, camera );
	controls.update();

}

// keep address bar pointed to latest
window.history.pushState( '', '', '/spider-covid-19-viz-3d/' );

</script>
</body>
</html>